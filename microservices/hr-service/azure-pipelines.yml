# Azure DevOps Pipeline for HR Service
trigger:
  branches:
    include:
      - main
      - master
      - production
  paths:
    include:
      - microservices/hr-service/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  serviceName: 'hr-service'
  dockerRegistryServiceConnection: 'AzureContainerRegistry'
  imageRepository: 'hr-service'
  containerRegistry: 'eteliosacr.azurecr.io'  # Updated to use actual ACR
  dockerfilePath: '$(Build.SourcesDirectory)/microservices/hr-service/Dockerfile'
  tag: '$(Build.BuildId)'
  resourceGroup: 'etelios-hrms-rg'
  appServiceName: 'etelios-hr-service'  # Updated to standard name
  keyVaultName: 'etelios-keyvault'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: Build
    displayName: 'Build HR Service'
    steps:
    - task: Docker@2
      displayName: 'Build and push image'
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          latest

- stage: Deploy
  displayName: 'Deploy to Azure App Service'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: 'Deploy HR Service'
    environment: 'production-hr-service'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureKeyVault@2
            displayName: 'Get secrets from Key Vault'
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              KeyVaultName: '$(keyVaultName)'
              SecretsFilter: 'mongo-uri,jwt-secret,jwt-refresh-secret,azure-storage-connection-string'
              RunAsPreJob: true

          - task: AzureWebAppContainer@1
            displayName: 'Deploy to Azure App Service'
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              appName: '$(appServiceName)'
              containers: '$(containerRegistry)/$(imageRepository):latest'
              appSettings: '-WEBSITES_PORT "3002" -NODE_ENV "production" -PORT "3002" -SERVICE_NAME "hr-service" -MONGO_URI "$(mongo-uri)" -JWT_SECRET "$(jwt-secret)" -JWT_REFRESH_SECRET "$(jwt-refresh-secret)" -JWT_EXPIRY "1h" -JWT_REFRESH_EXPIRY "7d" -CORS_ORIGIN "https://your-frontend.azurewebsites.net" -FRONTEND_URL "https://your-frontend.azurewebsites.net" -AZURE_FRONTEND_URL "https://your-frontend.azurewebsites.net" -STORAGE_PROVIDER "azure" -AZURE_STORAGE_CONNECTION_STRING "$(azure-storage-connection-string)" -LOG_LEVEL "info" -TEST_MODE "false" -ENABLE_ROLE_SEEDING "false"'

          - task: AzureAppServiceManage@0
            displayName: 'Restart App Service'
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              Action: 'Restart Azure App Service'
              WebAppName: '$(appServiceName)'
