# Azure DevOps Pipeline for AKS Deployment
# This pipeline builds Docker images and deploys to Azure Kubernetes Service (AKS)
trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/*'

variables:
  - name: ACR_NAME
    value: 'eteliosacr-hvawabdbgge7e0fu'
  - name: ACR_LOGIN_SERVER
    value: 'eteliosacr-hvawabdbgge7e0fu.azurecr.io'
  - name: AKS_RESOURCE_GROUP
    value: 'Etelios-AKS-RG'
  - name: AKS_CLUSTER_NAME
    value: 'Etelios-AKS'
  - name: NAMESPACE
    value: 'etelios-backend-prod'
  - name: IMAGE_TAG
    value: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build and Push Docker Images'
  jobs:
  - job: BuildImages
    displayName: 'Build All Service Images'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Docker@2
      displayName: 'Build and Push API Gateway'
      inputs:
        command: buildAndPush
        repository: api-gateway
        dockerfile: Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Auth Service'
      inputs:
        command: buildAndPush
        repository: auth-service
        dockerfile: microservices/auth-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push HR Service'
      inputs:
        command: buildAndPush
        repository: hr-service
        dockerfile: microservices/hr-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Attendance Service'
      inputs:
        command: buildAndPush
        repository: attendance-service
        dockerfile: microservices/attendance-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Payroll Service'
      inputs:
        command: buildAndPush
        repository: payroll-service
        dockerfile: microservices/payroll-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push CRM Service'
      inputs:
        command: buildAndPush
        repository: crm-service
        dockerfile: microservices/crm-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Inventory Service'
      inputs:
        command: buildAndPush
        repository: inventory-service
        dockerfile: microservices/inventory-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Sales Service'
      inputs:
        command: buildAndPush
        repository: sales-service
        dockerfile: microservices/sales-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Purchase Service'
      inputs:
        command: buildAndPush
        repository: purchase-service
        dockerfile: microservices/purchase-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Financial Service'
      inputs:
        command: buildAndPush
        repository: financial-service
        dockerfile: microservices/financial-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Document Service'
      inputs:
        command: buildAndPush
        repository: document-service
        dockerfile: microservices/document-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Service Management'
      inputs:
        command: buildAndPush
        repository: service-management
        dockerfile: microservices/service-management/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push CPP Service'
      inputs:
        command: buildAndPush
        repository: cpp-service
        dockerfile: microservices/cpp-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Prescription Service'
      inputs:
        command: buildAndPush
        repository: prescription-service
        dockerfile: microservices/prescription-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Analytics Service'
      inputs:
        command: buildAndPush
        repository: analytics-service
        dockerfile: microservices/analytics-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Notification Service'
      inputs:
        command: buildAndPush
        repository: notification-service
        dockerfile: microservices/notification-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Monitoring Service'
      inputs:
        command: buildAndPush
        repository: monitoring-service
        dockerfile: microservices/monitoring-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Tenant Registry Service'
      inputs:
        command: buildAndPush
        repository: tenant-registry-service
        dockerfile: microservices/tenant-registry-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Realtime Service'
      inputs:
        command: buildAndPush
        repository: realtime-service
        dockerfile: microservices/realtime-service/Dockerfile
        containerRegistry: 'AzureContainerRegistry'
        tags: |
          $(IMAGE_TAG)
          latest

- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployToAKS
    displayName: 'Deploy to AKS Cluster'
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'etelios-aks-production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Bash@3
            displayName: 'Verify kubectl connection'
            inputs:
              targetType: 'inline'
              script: |
                kubectl version --client
                kubectl cluster-info
          
          - task: Bash@3
            displayName: 'Generate Kubernetes Manifests'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x k8s/generate-manifests.sh
                export ACR_NAME=$(ACR_NAME)
                export IMAGE_TAG=$(IMAGE_TAG)
                export NAMESPACE=$(NAMESPACE)
                ./k8s/generate-manifests.sh
          
          - task: Kubernetes@1
            displayName: 'Create Namespace'
            inputs:
              connectionType: 'kubernetesServiceConnection'
              kubernetesServiceEndpoint: 'AKS-Service-Connection'
              namespace: '$(NAMESPACE)'
              command: 'apply'
              arguments: '-f k8s/namespace.yaml'
              secretType: 'generic'
          
          - task: Kubernetes@1
            displayName: 'Apply ConfigMap'
            inputs:
              connectionType: 'kubernetesServiceConnection'
              kubernetesServiceEndpoint: 'AKS-Service-Connection'
              namespace: '$(NAMESPACE)'
              command: 'apply'
              arguments: '-f k8s/configmap.yaml'
              secretType: 'generic'
          
          - task: Kubernetes@1
            displayName: 'Apply Secrets'
            inputs:
              connectionType: 'kubernetesServiceConnection'
              kubernetesServiceEndpoint: 'AKS-Service-Connection'
              namespace: '$(NAMESPACE)'
              command: 'apply'
              arguments: '-f k8s/secrets.yaml'
              secretType: 'generic'
          
          - task: Kubernetes@1
            displayName: 'Deploy API Gateway'
            inputs:
              connectionType: 'kubernetesServiceConnection'
              kubernetesServiceEndpoint: 'AKS-Service-Connection'
              namespace: '$(NAMESPACE)'
              command: 'apply'
              arguments: '-f k8s/api-gateway.yaml'
              secretType: 'generic'
          
          - task: Kubernetes@1
            displayName: 'Deploy All Microservices'
            inputs:
              connectionType: 'kubernetesServiceConnection'
              kubernetesServiceEndpoint: 'AKS-Service-Connection'
              namespace: '$(NAMESPACE)'
              command: 'apply'
              arguments: '-f k8s/deployments/'
              secretType: 'generic'
          
          - task: Kubernetes@1
            displayName: 'Apply Ingress'
            inputs:
              connectionType: 'kubernetesServiceConnection'
              kubernetesServiceEndpoint: 'AKS-Service-Connection'
              namespace: '$(NAMESPACE)'
              command: 'apply'
              arguments: '-f k8s/ingress.yaml'
              secretType: 'generic'
          
          - task: Bash@3
            displayName: 'Wait for Deployments'
            inputs:
              targetType: 'inline'
              script: |
                kubectl wait --for=condition=available --timeout=300s deployment --all -n $(NAMESPACE) || true
                kubectl get deployments -n $(NAMESPACE)
                kubectl get services -n $(NAMESPACE)
                kubectl get ingress -n $(NAMESPACE)
