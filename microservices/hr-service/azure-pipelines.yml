# Azure DevOps Pipeline for HR Service
trigger:
  branches:
    include:
      - main
      - master
      - production
  paths:
    include:
      - microservices/hr-service/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  serviceName: 'hr-service'
  dockerRegistryServiceConnection: 'AzureContainerRegistry'
  imageRepository: 'hr-service'
  containerRegistry: 'eteliosregistry.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/microservices/hr-service/Dockerfile'
  tag: '$(Build.BuildId)'
  resourceGroup: 'etelios-hrms-rg'
  appServiceName: 'etelios-hr-service'
  keyVaultName: 'etelios-keyvault'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: Build
    displayName: 'Build HR Service'
    steps:
    - task: Docker@2
      displayName: 'Build and push image'
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

- stage: Deploy
  displayName: 'Deploy to Azure App Service'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: 'Deploy HR Service'
    environment: 'production-hr-service'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureKeyVault@2
            displayName: 'Get secrets from Key Vault'
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              KeyVaultName: '$(keyVaultName)'
              SecretsFilter: 'mongo-uri,jwt-secret,jwt-refresh-secret,azure-storage-connection-string'
              RunAsPreJob: true

          - task: AzureWebAppContainer@1
            displayName: 'Deploy to Azure App Service'
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              appName: '$(appServiceName)'
              containers: '$(containerRegistry)/$(imageRepository):$(tag)'
              appSettings: |
                [
                  {
                    "name": "WEBSITES_PORT",
                    "value": "3002"
                  },
                  {
                    "name": "NODE_ENV",
                    "value": "production"
                  },
                  {
                    "name": "PORT",
                    "value": "3002"
                  },
                  {
                    "name": "SERVICE_NAME",
                    "value": "hr-service"
                  },
                  {
                    "name": "MONGO_URI",
                    "value": "$(mongo-uri)"
                  },
                  {
                    "name": "JWT_SECRET",
                    "value": "$(jwt-secret)"
                  },
                  {
                    "name": "JWT_REFRESH_SECRET",
                    "value": "$(jwt-refresh-secret)"
                  },
                  {
                    "name": "JWT_EXPIRY",
                    "value": "1h"
                  },
                  {
                    "name": "JWT_REFRESH_EXPIRY",
                    "value": "7d"
                  },
                  {
                    "name": "CORS_ORIGIN",
                    "value": "https://your-frontend.azurewebsites.net"
                  },
                  {
                    "name": "FRONTEND_URL",
                    "value": "https://your-frontend.azurewebsites.net"
                  },
                  {
                    "name": "AZURE_FRONTEND_URL",
                    "value": "https://your-frontend.azurewebsites.net"
                  },
                  {
                    "name": "STORAGE_PROVIDER",
                    "value": "azure"
                  },
                  {
                    "name": "AZURE_STORAGE_CONNECTION_STRING",
                    "value": "$(azure-storage-connection-string)"
                  },
                  {
                    "name": "LOG_LEVEL",
                    "value": "info"
                  },
                  {
                    "name": "TEST_MODE",
                    "value": "false"
                  },
                  {
                    "name": "ENABLE_ROLE_SEEDING",
                    "value": "false"
                  }
                ]

          - task: AzureAppServiceManage@0
            displayName: 'Restart App Service'
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              Action: 'Restart Azure App Service'
              WebAppName: '$(appServiceName)'
