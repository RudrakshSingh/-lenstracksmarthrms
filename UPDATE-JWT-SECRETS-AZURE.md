# Update JWT Secrets in Azure

## Generated Secrets

**JWT_SECRET:**
```
f0d8a229b4f0d48a8a1e01e41c84076bd39e3445b4a677bbdf9b6c73044f6d54a2271de85572d631098a442efe0f72c8826d31a39d2bda35b3a3e54fa67f7565
```

**JWT_REFRESH_SECRET:**
```
5dc6de32b2f8125ad6c3d72f4f6920a900e6858e1bd2848410aa615c839231db0a1692a079b60c421285910a93e28c13a63aabc3da9786d4f6a3ed77bac4e947
```

---

## Option 1: Update in Azure Key Vault (Recommended)

If you're using Azure Key Vault, store the secrets there:

```bash
# Update JWT Secret
az keyvault secret set \
  --vault-name <your-keyvault-name> \
  --name "kv-jwt-secret" \
  --value "f0d8a229b4f0d48a8a1e01e41c84076bd39e3445b4a677bbdf9b6c73044f6d54a2271de85572d631098a442efe0f72c8826d31a39d2bda35b3a3e54fa67f7565"

# Update JWT Refresh Secret
az keyvault secret set \
  --vault-name <your-keyvault-name> \
  --name "kv-jwt-refresh-secret" \
  --value "5dc6de32b2f8125ad6c3d72f4f6920a900e6858e1bd2848410aa615c839231db0a1692a079b60c421285910a93e28c13a63aabc3da9786d4f6a3ed77bac4e947"
```

**Note:** The code will automatically fetch these from Key Vault if `USE_KEY_VAULT=true` is set.

---

## Option 2: Update in App Service Environment Variables

### For Auth Service:

```bash
az webapp config appsettings set \
  --name etelios-auth-service-h8btakd4byhncmgc \
  --resource-group <your-resource-group> \
  --settings \
    JWT_SECRET="f0d8a229b4f0d48a8a1e01e41c84076bd39e3445b4a677bbdf9b6c73044f6d54a2271de85572d631098a442efe0f72c8826d31a39d2bda35b3a3e54fa67f7565" \
    JWT_REFRESH_SECRET="5dc6de32b2f8125ad6c3d72f4f6920a900e6858e1bd2848410aa615c839231db0a1692a079b60c421285910a93e28c13a63aabc3da9786d4f6a3ed77bac4e947"
```

### For HR Service:

```bash
az webapp config appsettings set \
  --name etelios-hr-service-backend-a4ayeqefdsbsc2g3 \
  --resource-group <your-resource-group> \
  --settings \
    JWT_SECRET="f0d8a229b4f0d48a8a1e01e41c84076bd39e3445b4a677bbdf9b6c73044f6d54a2271de85572d631098a442efe0f72c8826d31a39d2bda35b3a3e54fa67f7565" \
    JWT_REFRESH_SECRET="5dc6de32b2f8125ad6c3d72f4f6920a900e6858e1bd2848410aa615c839231db0a1692a079b60c421285910a93e28c13a63aabc3da9786d4f6a3ed77bac4e947"
```

### For API Gateway:

```bash
az webapp config appsettings set \
  --name etelios-app-service-cxf6hvgjb7gah7dr \
  --resource-group <your-resource-group> \
  --settings \
    JWT_SECRET="f0d8a229b4f0d48a8a1e01e41c84076bd39e3445b4a677bbdf9b6c73044f6d54a2271de85572d631098a442efe0f72c8826d31a39d2bda35b3a3e54fa67f7565" \
    JWT_REFRESH_SECRET="5dc6de32b2f8125ad6c3d72f4f6920a900e6858e1bd2848410aa615c839231db0a1692a079b60c421285910a93e28c13a63aabc3da9786d4f6a3ed77bac4e947"
```

---

## Important Notes

1. **Both services MUST use the same JWT secrets** - Otherwise tokens generated by one service won't be valid in the other.

2. **After updating secrets, restart all services:**
   ```bash
   # Restart Auth Service
   az webapp restart \
     --name etelios-auth-service-h8btakd4byhncmgc \
     --resource-group <your-resource-group>
   
   # Restart HR Service
   az webapp restart \
     --name etelios-hr-service-backend-a4ayeqefdsbsc2g3 \
     --resource-group <your-resource-group>
   
   # Restart API Gateway (if JWT secrets are used there)
   az webapp restart \
     --name etelios-app-service-cxf6hvgjb7gah7dr \
     --resource-group <your-resource-group>
   ```

3. **Existing tokens will be invalidated** - After updating JWT secrets, all existing tokens will become invalid. Users will need to log in again.

4. **Security Best Practice:**
   - Store secrets in Azure Key Vault (Option 1) for better security
   - Never commit secrets to Git
   - Rotate secrets periodically (every 90 days recommended)

---

## Verify Secrets Are Set

### Check Key Vault Secrets:
```bash
az keyvault secret show \
  --vault-name <your-keyvault-name> \
  --name kv-jwt-secret \
  --query value

az keyvault secret show \
  --vault-name <your-keyvault-name> \
  --name kv-jwt-refresh-secret \
  --query value
```

### Check App Service Environment Variables:
```bash
# Auth Service
az webapp config appsettings list \
  --name etelios-auth-service-h8btakd4byhncmgc \
  --resource-group <your-resource-group> \
  --query "[?name=='JWT_SECRET' || name=='JWT_REFRESH_SECRET']"

# HR Service
az webapp config appsettings list \
  --name etelios-hr-service-backend-a4ayeqefdsbsc2g3 \
  --resource-group <your-resource-group> \
  --query "[?name=='JWT_SECRET' || name=='JWT_REFRESH_SECRET']"
```

---

## Quick Update Script (All Services)

If you want to update all services at once:

```bash
#!/bin/bash

RESOURCE_GROUP="<your-resource-group>"
JWT_SECRET="f0d8a229b4f0d48a8a1e01e41c84076bd39e3445b4a677bbdf9b6c73044f6d54a2271de85572d631098a442efe0f72c8826d31a39d2bda35b3a3e54fa67f7565"
JWT_REFRESH_SECRET="5dc6de32b2f8125ad6c3d72f4f6920a900e6858e1bd2848410aa615c839231db0a1692a079b60c421285910a93e28c13a63aabc3da9786d4f6a3ed77bac4e947"

# Update Auth Service
az webapp config appsettings set \
  --name etelios-auth-service-h8btakd4byhncmgc \
  --resource-group $RESOURCE_GROUP \
  --settings \
    JWT_SECRET="$JWT_SECRET" \
    JWT_REFRESH_SECRET="$JWT_REFRESH_SECRET"

# Update HR Service
az webapp config appsettings set \
  --name etelios-hr-service-backend-a4ayeqefdsbsc2g3 \
  --resource-group $RESOURCE_GROUP \
  --settings \
    JWT_SECRET="$JWT_SECRET" \
    JWT_REFRESH_SECRET="$JWT_REFRESH_SECRET"

# Update API Gateway
az webapp config appsettings set \
  --name etelios-app-service-cxf6hvgjb7gah7dr \
  --resource-group $RESOURCE_GROUP \
  --settings \
    JWT_SECRET="$JWT_SECRET" \
    JWT_REFRESH_SECRET="$JWT_REFRESH_SECRET"

echo "JWT secrets updated. Restarting services..."

# Restart all services
az webapp restart --name etelios-auth-service-h8btakd4byhncmgc --resource-group $RESOURCE_GROUP
az webapp restart --name etelios-hr-service-backend-a4ayeqefdsbsc2g3 --resource-group $RESOURCE_GROUP
az webapp restart --name etelios-app-service-cxf6hvgjb7gah7dr --resource-group $RESOURCE_GROUP

echo "All services restarted. JWT secrets are now active."
```

Save this as `update-jwt-secrets.sh`, make it executable (`chmod +x update-jwt-secrets.sh`), and run it.

---

**Last Updated:** 2025-11-27

