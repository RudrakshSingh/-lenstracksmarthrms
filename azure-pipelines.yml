# Azure DevOps Pipeline Configuration
# This file should be placed in the root of your Azure DevOps repository

trigger:
- main
- develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'
  azureSubscription: 'Azure Service Connection'
  resourceGroupName: 'etelios-rg'
  dockerRegistryServiceConnection: 'AzureContainerRegistry'  # Service connection name in Azure DevOps
  containerRegistry: 'etelios.azurecr.io'  # Registry URL (for image references)
  imageRepository: 'etelios'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildJob
    displayName: 'Build Job'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Install Node.js'

    - script: |
        npm ci
        npm run lint
        npm test
      displayName: 'Install dependencies, lint, and test'
      env:
        NODE_ENV: test
        MONGO_URI: mongodb://localhost:27017/hrms_test
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        JWT_SECRET: test-jwt-secret
        JWT_REFRESH_SECRET: test-refresh-secret

    - task: PublishTestResults@2
      inputs:
        testResultsFiles: '**/test-results.xml'
        testRunTitle: 'Node.js Tests'
      condition: succeededOrFailed()

    - task: PublishCodeCoverageResults@1
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
      condition: succeededOrFailed()

- stage: BuildDocker
  displayName: 'Build Docker Images'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DockerBuildJob
    displayName: 'Docker Build Job'
    steps:
    - task: Docker@2
      displayName: 'Build and push Docker image'
      inputs:
        command: 'buildAndPush'
        repository: '$(imageRepository)'
        dockerfile: '$(dockerfilePath)'
        containerRegistry: '$(dockerRegistryServiceConnection)'
        tags: |
          $(tag)
          latest

- stage: DeployStaging
  displayName: 'Deploy to Staging'
  dependsOn: BuildDocker
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - deployment: DeployStagingJob
    displayName: 'Deploy to Staging'
    environment: 'staging'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure App Service (Staging)'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: 'etelios-staging'
              package: '$(Build.SourcesDirectory)'
              deploymentMethod: 'zipDeploy'

          - task: AzureCLI@2
            displayName: 'Deploy to Azure Container Instances (Staging)'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az container create \
                  --resource-group $(resourceGroupName) \
                  --name etelios-staging-container \
                  --image $(containerRegistry)/$(imageRepository):$(tag) \
                  --cpu 2 \
                  --memory 4 \
                  --ports 3000 \
                  --environment-variables \
                    NODE_ENV=staging \
                    MONGO_URI=$(MONGO_URI) \
                    REDIS_HOST=$(REDIS_HOST) \
                    JWT_SECRET=$(JWT_SECRET)

- stage: DeployProduction
  displayName: 'Deploy to Production'
  dependsOn: BuildDocker
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployProductionJob
    displayName: 'Deploy to Production'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure App Service (Production)'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: 'etelios-app-service-cxf6hvgjb7gah7dr'
              package: '$(Build.SourcesDirectory)'
              deploymentMethod: 'zipDeploy'

          - task: AzureCLI@2
            displayName: 'Deploy to Azure Container Instances (Production)'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az container create \
                  --resource-group $(resourceGroupName) \
                  --name etelios-production-container \
                  --image $(containerRegistry)/$(imageRepository):$(tag) \
                  --cpu 4 \
                  --memory 8 \
                  --ports 3000 \
                  --environment-variables \
                    NODE_ENV=production \
                    MONGO_URI=$(MONGO_URI) \
                    REDIS_HOST=$(REDIS_HOST) \
                    JWT_SECRET=$(JWT_SECRET)

          - task: AzureCLI@2
            displayName: 'Update Azure Container Instances'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Update existing container with new image
                az container delete --resource-group $(resourceGroupName) --name etelios-production-container --yes
                az container create \
                  --resource-group $(resourceGroupName) \
                  --name etelios-production-container \
                  --image $(containerRegistry)/$(imageRepository):$(tag) \
                  --cpu 4 \
                  --memory 8 \
                  --ports 3000 \
                  --environment-variables \
                    NODE_ENV=production \
                    MONGO_URI=$(MONGO_URI) \
                    REDIS_HOST=$(REDIS_HOST) \
                    JWT_SECRET=$(JWT_SECRET)

- stage: SecurityScan
  displayName: 'Security Scan'
  dependsOn: BuildDocker
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: SecurityScanJob
    displayName: 'Security Scan Job'
    steps:
    - task: Docker@2
      displayName: 'Run Trivy Security Scan'
      inputs:
        command: 'run'
        arguments: '--image $(containerRegistry)/$(imageRepository):$(tag) --scan-type vuln --format table'

    - task: AzureCLI@2
      displayName: 'Azure Security Center Scan'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Run security scan on Azure resources
          az security assessment create \
            --resource-group $(resourceGroupName) \
            --assessment-name "Container Security Assessment" \
            --assessment-type "Container Security" \
            --status "Healthy"

- stage: Monitoring
  displayName: 'Setup Monitoring'
  dependsOn: DeployProduction
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: MonitoringJob
    displayName: 'Monitoring Setup Job'
    steps:
    - task: AzureCLI@2
      displayName: 'Setup Application Insights'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Create Application Insights
          az monitor app-insights component create \
            --resource-group $(resourceGroupName) \
            --app etelios-insights \
            --location eastus \
            --kind web

    - task: AzureCLI@2
      displayName: 'Setup Alerts'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Create alert rules
          az monitor metrics alert create \
            --name "High CPU Usage" \
            --resource-group $(resourceGroupName) \
            --scopes "/subscriptions/$(AZURE_SUBSCRIPTION_ID)/resourceGroups/$(resourceGroupName)" \
            --condition "avg Percentage CPU > 80" \
            --description "Alert when CPU usage is high"
