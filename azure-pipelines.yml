# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  # Container registry service connection - use name instead of GUID for consistency
  dockerRegistryServiceConnection: 'c405786f-9b3e-4c33-92a4-75a3522f83a7'
  imageRepository: 'eteliosbackend'
  containerRegistry: 'eteliosacr-hvawabdbgge7e0fu.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          latest

- stage: Deploy
  displayName: Deploy to Azure App Service
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: Deploy Main API Gateway
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebAppContainer@1
            displayName: 'Deploy to Azure App Service'
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              appName: 'etelios-app-service-cxf6hvgjb7gah7dr'
              containers: '$(containerRegistry)/$(imageRepository):latest'
              appSettings: |
                [
                  {
                    "name": "WEBSITES_PORT",
                    "value": "3000"
                  },
                  {
                    "name": "PORT",
                    "value": "3000"
                  },
                  {
                    "name": "NODE_ENV",
                    "value": "production"
                  },
                  {
                    "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                    "value": "false"
                  }
                ]

          - task: AzureAppServiceManage@0
            displayName: 'Restart App Service to apply changes'
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              Action: 'Restart Azure App Service'
              WebAppName: 'etelios-app-service-cxf6hvgjb7gah7dr'
